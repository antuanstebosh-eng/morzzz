<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>–î–æ–∂–¥—å ‚Üí –°–ª–æ–≤–∞</title>

<style>
body {
  background:#0b1020;
  color:#e5e7eb;
  font-family:system-ui,sans-serif;
  padding:20px;
}
h1 { text-align:center; }
button {
  width:100%;
  padding:14px;
  margin:6px 0;
  font-size:16px;
  border:none;
  border-radius:10px;
  background:#2563eb;
  color:white;
}
button.gray { background:#334155; }
textarea {
  width:100%;
  height:120px;
  margin-top:10px;
  background:#020617;
  color:#e5e7eb;
  border-radius:10px;
  padding:10px;
}
.mode {
  text-align:center;
  opacity:.8;
}
</style>
</head>

<body>

<h1>üåß –î–æ–∂–¥—å ‚Üí –°–ª–æ–≤–∞</h1>

<div class="mode" id="modeLabel">–†–µ–∂–∏–º: –ú–æ—Ä–∑–µ</div>

<button onclick="toggleMode()">üîÑ –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Ä–µ–∂–∏–º</button>
<button onclick="start()">‚ñ∂Ô∏è –°–ª—É—à–∞—Ç—å</button>
<button onclick="stop()" class="gray">‚èπ –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
<button onclick="convert()" class="gray">üî§ –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞—Ç—å</button>

<h3>–°–∏–≥–Ω–∞–ª—ã</h3>
<textarea id="signals"></textarea>

<h3>–†–µ–∑—É–ª—å—Ç–∞—Ç</h3>
<textarea id="result"></textarea>

<script>
let ctx, analyser, data;
let running = false;
let lastSound = 0;

let mode = "morse";
let signals = "";
let poetry = "";

const MORSE = {
  ".-":"–ê","-...":"–ë","--.":"–ì","-..":"–î",".":"–ï","...":"–°",
  "---":"–û","-.":"–ù","--":"–ú","..":"–ò",".-.":"–†","-.-":"–ö"
};

const WORDS = {
  quiet:["—Ç–∏—Ö–æ","–∫–∞–ø–ª–∏","–Ω–æ—á—å","—Å–æ–Ω"],
  mid:["–≥–æ—Ä–æ–¥","–æ–∫–Ω–∞","—à–æ—Ä–æ—Ö","—É–ª–∏—Ü—ã"],
  loud:["–≥—Ä–æ–º","–≤–µ—Ç–µ—Ä","–ø–∞–º—è—Ç—å","–∫—Ä–∏–∫"]
};

function toggleMode(){
  mode = mode === "morse" ? "poetry" : "morse";
  document.getElementById("modeLabel").innerText =
    "–†–µ–∂–∏–º: " + (mode==="morse"?"–ú–æ—Ä–∑–µ":"–î–æ–∂–¥—å ‚Üí –ü–æ—ç–∑–∏—è");
}

async function start(){
  ctx = new (window.AudioContext||window.webkitAudioContext)();
  const stream = await navigator.mediaDevices.getUserMedia({audio:true});
  const src = ctx.createMediaStreamSource(stream);

  analyser = ctx.createAnalyser();
  analyser.fftSize = 256;
  data = new Uint8Array(analyser.frequencyBinCount);

  src.connect(analyser);
  running = true;
  loop();
}

function stop(){
  running = false;
}

function loop(){
  if(!running) return;

  analyser.getByteFrequencyData(data);
  let volume = data.reduce((a,b)=>a+b)/data.length;
  let now = Date.now();

  if(mode==="morse"){
    if(volume>40){
      lastSound = now;
    } else {
      let d = now-lastSound;
      if(d>120 && d<300){ signals+="."; lastSound=now; }
      if(d>=300 && d<700){ signals+="-"; lastSound=now; }
    }
    document.getElementById("signals").value = signals;
  }

  if(mode==="poetry"){
    if(Math.random()<0.04){
      poetry += pick(volume)+" ";
      document.getElementById("result").value = poetry;
    }
  }

  requestAnimationFrame(loop);
}

function pick(v){
  if(v<20) return rand(WORDS.quiet);
  if(v<40) return rand(WORDS.mid);
  return rand(WORDS.loud);
}
function rand(a){ return a[Math.floor(Math.random()*a.length)]; }

function convert(){
  if(mode!=="morse") return;

  let text = "";
  let parts = signals.split(/(?<=\.)|(?<=-)/);

  let buffer = "";
  for(let s of signals){
    if(s==="."||s==="-"){
      buffer+=s;
    } else {
      text += MORSE[buffer]||"";
      buffer="";
    }
  }
  text += MORSE[buffer]||"";

  document.getElementById("result").value = text;
}
</script>

</body>
</html>